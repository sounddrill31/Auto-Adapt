name: Add LineageOS Device Tree

on:
  workflow_dispatch:
    inputs:
      LOSDT:
        description: 'LineageOS Device Tree URL'
        required: true
        default: 'sounddrill31/android_device_xiaomi_gauguin'
      LOSBRANCH:
        description: 'LineageOS Device Tree Branch'
        required: true
        default: 'lineage-21'
      FINALBRANCH:
        description: 'Output Branch'
        required: true
        default: 'lmo-fourteen'

jobs:
  add-device:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Set Up Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"

      - name: Run add-device.sh script
        run: |
          #./lmodroid/add-device-from-lineage/fork-and-push.sh $LOS_DT $LOS_BRANCH $LOS_DT $FINAL_BRANCH
          repo_src=$LOS_DT
          branch_src=$LOS_BRANCH
          repo_dist=$LOS_DT
          branch_dist=$FINAL_BRANCH

          git clone https://github.com/${repo_src}.git lineage/ -b ${branch_src}
          cd lineage
          git switch -c ${branch_dist}

          # Adapt
          python "../lmodroid/lineage-device-tree/adapt-to-lmodroid.py" . ${branch_src}

          git add -A
          git commit -m "Adapt to LMODroid by device-add script"

          git push --set-upstream -o skip-validation origin ${branch_dist}

        env:
          LOS_DT: ${{ inputs.LOSDT }}
          LOS_BRANCH: ${{ inputs.LOSBRANCH }}
          FINAL_BRANCH: ${{ inputs.FINALBRANCH }}
          GITHUB_TOKEN: ${{ secrets.PAT }}
